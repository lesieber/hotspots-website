<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <meta charset="UTF-8">
    <title>Generate Json</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #b8b8b8;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --button-bg: #2e2e2e;
            --button-hover: #636363;
            --delete-btn: #e53935;
            --delete-hover: #c62828;
        }
        
        body {
            font-family: "Segoe UI", sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 40px;
            display: flex;
            justify-content: center;
        }
        
        .container {
            display: flex;
            gap: 40px;
            max-width: 900px;
            width: 100%;
        }
        
        .preview {
            flex: 1;
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            background: var(--card-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 300px;
        }
        
        .preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        
        .controls {
            width: 250px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            background: var(--card-bg);
            cursor: pointer;
            transition: border-color 0.3s;
        }
        
        .upload-area:hover {
            border-color: var(--button-bg);
        }
        
        button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            background: var(--button-bg);
            color: #b8b8b8;
            transition: background 0.3s;
        }
        
        button:hover {
            background: var(--button-hover);
        }
        
        .textbox {
            margin-top: 20px;
            white-space: pre;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            min-height: 100px;
            font-size: 14px;
            color: var(--text-color);
            overflow-y: auto;
            overflow-x: auto;
        }
        
        input[type="text"] {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        input[type="text"]::placeholder {
            color: #888;
        }
        
        .dot {
            position: absolute;
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            pointer-events: none;
        }
        
        .new-area-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--card-bg);
        }
        
        .new-area-container button {
            background: var(--delete-btn);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .new-area-container button:hover {
            background: var(--delete-hover);
        }
        
        .area-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .area-info input {
            flex: 1;
        }
        
        .area-points {
            font-size: 12px;
            color: #aaa;
            margin-top: 5px;
        }
        
        .active-area {
            border-color: var(--button-bg);
        }
        
        .area-controls {
            display: flex;
            gap: 10px;
        }
        
        .area-controls button {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="preview" id="preview">
            <span>Image preview will appear here</span>
        </div>
        <div class="controls">
            <input type="text" id="img-name" placeholder="Enter image name here">
            <div class="upload-area" id="upload-area">
                Drag & Drop Image Here
                <br><br>
                <input type="file" id="file-input" accept="image/*" style="display:none;">
                <button onclick="document.getElementById('file-input').click()">Upload Image</button>
            </div>
            <button id="new-area-btn">New Area</button>
            <button id="finish-area-btn" disabled>Finish Area</button>
            <button id="generate-code">Generate Code</button>
            <div id="dynamic-area-wrapper">
                <div class="textbox" id="textbox">
                    Code will be shown here...
                </div>
            </div>
            <button id="copy-code">Copy Code</button>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('file-input');
        const preview = document.getElementById('preview');
        const uploadArea = document.getElementById('upload-area');
        const imgName = document.getElementById('img-name');
        const newAreaBtn = document.getElementById('new-area-btn');
        const finishAreaBtn = document.getElementById('finish-area-btn');
        const generateCodeBtn = document.getElementById('generate-code');
        const copyCodeBtn = document.getElementById('copy-code');
        const textbox = document.getElementById('textbox');
        const dynamicAreaWrapper = document.getElementById('dynamic-area-wrapper');
        
        let areas = []; 
        let currentArea = null; 
        let image = null; 
        
        function init() {
            fileInput.addEventListener('change', handleFileUpload);
            uploadArea.addEventListener('dragover', handleDragOver);
            uploadArea.addEventListener('dragleave', handleDragLeave);
            uploadArea.addEventListener('drop', handleDrop);
            newAreaBtn.addEventListener('click', createNewArea);
            finishAreaBtn.addEventListener('click', finishCurrentArea);
            generateCodeBtn.addEventListener('click', generateCode);
            copyCodeBtn.addEventListener('click', copyCode);
        }
        
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    preview.innerHTML = `<div class="image-container" style="position:relative; display:inline-block;"><img id="image" src="${reader.result}" alt="Uploaded Image"></div>`;
                    image = document.getElementById('image');
                    image.onload = () => {
                        
                        areas = [];
                        currentArea = null;
                        updateAreaList();
                        finishAreaBtn.disabled = true;
                        imgName.value = file.name.split(".")[0];
                    };
                };
                reader.readAsDataURL(file);
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.style.borderColor = "var(--button-bg)";
        }
        
        function handleDragLeave() {
            uploadArea.style.borderColor = "var(--border-color)";
        }
        
        function handleDrop(e) {
            e.preventDefault();
            uploadArea.style.borderColor = "var(--border-color)";
            const file = e.dataTransfer.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = () => {
                    preview.innerHTML = `<div class="image-container" style="position:relative; display:inline-block;"><img id="image" src="${reader.result}" alt="Uploaded Image"></div>`;
                    image = document.getElementById('image');
                    image.onload = () => {
                        
                        areas = [];
                        currentArea = null;
                        updateAreaList();
                        finishAreaBtn.disabled = true;
                    };
                };
                reader.readAsDataURL(file);
            }
        }
        
        function createNewArea() {
            if (!image) {
                alert('Please upload an image first.');
                return;
            }
            
            if (currentArea) {
                finishCurrentArea();
            }
            
            const newArea = {
                id: Date.now(), 
                name: '',
                points: [],
                dots: []
            };
            
            areas.push(newArea);
            currentArea = newArea;
            
            enableImageClicking();
            
            updateAreaList();
            finishAreaBtn.disabled = false;
        }
        
        function enableImageClicking() {
            if (!image) return;
            
            image.removeEventListener('click', handleImageClick);
            
            image.addEventListener('click', handleImageClick);
        }
        
        function handleImageClick(e) {
            if (!currentArea) return;
            
            const rect = image.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const maxX = rect.width;
            const maxY = rect.height;
            
            const normalizedPoint = {
                x: x / maxX,
                y: 1 - y / maxY
            };
            
            currentArea.points.push(normalizedPoint);
            
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.style.left = `${x - 5}px`;
            dot.style.top = `${y - 5}px`;
            image.parentElement.appendChild(dot);
            
            currentArea.dots.push(dot);
            
            updateAreaList();
        }
        
        function finishCurrentArea() {
            if (!currentArea) return;
            
            if (image) {
                image.removeEventListener('click', handleImageClick);
            }
            if (currentArea.points.length < 3) {
                alert('An area needs at least 3 points.');
                return;
            }

            if (currentArea.name.trim() === "") {
                alert('You have to enter an action for the specified area.');
                return;
            }
            currentArea = null;
            
            updateAreaList();
            finishAreaBtn.disabled = true;
        }
        
        function deleteArea(areaId) {
            
            const areaIndex = areas.findIndex(area => area.id === areaId);
            if (areaIndex === -1) return;
            
            const area = areas[areaIndex];
            
            area.dots.forEach(dot => {
                if (dot.parentElement) {
                    dot.parentElement.removeChild(dot);
                }
            });
            
            areas.splice(areaIndex, 1);
            
            if (currentArea && currentArea.id === areaId) {
                currentArea = null;
                finishAreaBtn.disabled = true;
                
                if (image) {
                    image.removeEventListener('click', handleImageClick);
                }
            }
            
            updateAreaList();
        }
        
        function updateAreaName(areaId, name) {
            const area = areas.find(area => area.id === areaId);
            if (area) {
                area.name = name;
            }
        }
        
        function updateAreaList() {
            
            const areaContainers = dynamicAreaWrapper.querySelectorAll('.new-area-container');
            areaContainers.forEach(container => {
                if (container.parentElement === dynamicAreaWrapper) {
                    dynamicAreaWrapper.removeChild(container);
                }
            });
            
            areas.forEach(area => {
                const areaContainer = document.createElement('div');
                areaContainer.className = `new-area-container ${currentArea && currentArea.id === area.id ? 'active-area' : ''}`;
                areaContainer.dataset.areaId = area.id;
                
                const areaInfo = document.createElement('div');
                areaInfo.className = 'area-info';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'action';
                input.value = area.name;
                input.addEventListener('input', (e) => {
                    updateAreaName(area.id, e.target.value);
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i>';
                deleteBtn.onclick = () => {
                    deleteArea(area.id);
                };
                
                areaInfo.appendChild(input);
                areaInfo.appendChild(deleteBtn);
                
                const areaPoints = document.createElement('div');
                areaPoints.className = 'area-points';
                areaPoints.textContent = `${area.points.length} points`;
                
                areaContainer.appendChild(areaInfo);
                areaContainer.appendChild(areaPoints);
                
                dynamicAreaWrapper.insertBefore(areaContainer, textbox);
            });
        }
        
        function generateCode() {
            const imageName = imgName.value.trim();
            if (areas.length === 0) {
                alert('There has to be at least one area.');
                return;
            }

            if (currentArea.points.length < 3) {
                alert('An area needs at least 3 points.');
                return;
            }

            if (currentArea.name.trim() === "") {
                alert('You have to enter an action for the specified area.');
                return;
            }
            
            const customHotspots = areas.map(area => {
                
                const polygonString = area.points.map(point => 
                    `${point.x},${point.y}`
                ).join(';');
                return {
                    action: area.name || "unnamed",
                    polygonString: polygonString
                };
            });
            
            const data = {
                [imageName]: {
                    path: `Assets/Images/${imageName}.jpg`,
                    customHotspots: customHotspots
                }
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            textbox.innerText = jsonString;
        }
        
        function copyCode() {
            const code = textbox.innerText;
            if (!code || code === "Code will be shown here...") {
                alert('No code to copy.');
                return;
            }
            
            navigator.clipboard.writeText(code)
                .then(() => {
                    alert('Code copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy code: ', err);
                    alert('Failed to copy code to clipboard.');
                });
        }       
        init();
    </script>
</body>
</html>
